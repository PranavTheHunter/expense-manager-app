<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Manager (Shared)</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        :root {
            --primary-color: #3b82f6; /* Blue-500 */
            --primary-dark: #1d4ed8; /* Blue-700 */
            --bg-light: #f3f4f6;
            --card-bg: #ffffff;
            --shadow-custom: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            min-height: 100vh;
        }

        .card {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-custom);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        /* Responsive layout using Grid for desktop */
        @media (min-width: 1024px) {
            #main-layout {
                grid-template-columns: 1fr 2fr;
            }
        }
    </style>
</head>
<body>

    <!-- 
        AUTHENTICATION GATE - Displayed first.
    -->
    <div id="auth-gate" class="flex items-center justify-center min-h-screen p-4">
        <div class="card w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Access Expense Manager</h1>
            <form id="password-form" class="space-y-4">
                <div>
                    <input type="password" id="access-password" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border text-center" 
                           placeholder="Enter Password">
                </div>
                <button type="submit" class="btn-primary w-full text-lg">Access Dashboard</button>
                <p id="password-error" class="text-red-500 text-sm hidden">Incorrect password. Please try again.</p>
            </form>
        </div>
    </div>

    <!-- MAIN APPLICATION DASHBOARD - Hidden initially -->
    <div id="app" class="p-4 lg:p-8 hidden">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">My Expense Tracker (Shared Data)</h1>
            <p class="text-sm text-gray-600">All entries are visible to all users who have access.</p>
        </header>

        <main id="main-layout" class="grid gap-6 lg:gap-8">
            <!-- Left Panel: Expense Entry Form -->
            <div class="card h-fit">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-2">Add New Expense</h2>

                <form id="expense-form" class="space-y-4">
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">Item/Category</label>
                        <select id="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                            <option value="">Select Category</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Gym">Gym/Fitness</option>
                            <option value="Groceries">Groceries</option>
                            <option value="Rent">Rent/Housing</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <!-- Input for specifying 'Other' category -->
                    <div id="other-category-container" class="hidden">
                        <label for="other-category-input" class="block text-sm font-medium text-gray-700">Specify 'Other' Category</label>
                        <input type="text" id="other-category-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="e.g., Car Wash, Donation">
                    </div>

                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">Amount (Rs)</label>
                        <input type="number" id="amount" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="e.g., 2100">
                    </div>

                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>

                    <div>
                        <label for="person" class="block text-sm font-medium text-gray-700">Person (Optional)</label>
                        <input type="text" id="person" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="e.g., John, Jane">
                    </div>

                    <button type="submit" class="btn-primary w-full text-lg">Record Expense</button>
                    <div id="message-box" class="mt-4 p-3 hidden rounded-md text-sm"></div>
                </form>
            </div>

            <!-- Right Panel: Dashboard, Filters, and Expenses -->
            <div>
                
                <!-- Current Month Total Summary Card -->
                <div class="card mb-6 p-6 bg-blue-600 text-white flex justify-between items-center rounded-xl shadow-xl">
                    <div>
                        <h2 class="text-xl font-medium opacity-80">Current Month's Total Spend</h2>
                        <p class="text-sm opacity-90" id="current-month-label">Calculating...</p>
                    </div>
                    <p class="text-4xl font-extrabold" id="current-month-total">Rs 0.00</p>
                </div>

                <!-- Global Filters Section -->
                <div class="card mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Global Filters</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="filter-category" class="block text-sm font-medium text-gray-700">Filter Category</label>
                            <select id="filter-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                <option value="all">All Categories</option>
                                <!-- Categories populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                        </div>
                    </div>
                </div>
                
                <!-- Overall Monthly Trend Chart -->
                <div class="card mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Monthly Trend (Applies Global Filters)</h2>
                    <div class="p-2">
                        <canvas id="monthly-trend-chart"></canvas>
                    </div>
                </div>

                <!-- Category Comparison Chart (NEW) -->
                <div class="card mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Category Comparison Analysis</h2>
                    
                    <div class="mb-4">
                        <label for="filter-comparison-categories" class="block text-sm font-medium text-gray-700">Select 2+ Categories for Comparison (Obeys Date Filters Only)</label>
                        <select multiple id="filter-comparison-categories" size="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border h-32">
                            <!-- Categories populated dynamically -->
                        </select>
                    </div>

                    <div class="p-2">
                        <canvas id="comparison-chart"></canvas>
                    </div>
                </div>

                <!-- Expense List -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Recent Transactions</h2>
                    <div id="expense-list-container" class="space-y-3">
                        <p id="loading-indicator" class="text-center text-gray-500">Loading expenses...</p>
                        <ul id="expense-list" class="divide-y divide-gray-100">
                            <!-- Expenses will be dynamically inserted here -->
                        </ul>
                        <p id="no-expenses" class="hidden text-center text-gray-500 italic">No expenses recorded yet or matching the current filter.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MASTER PASSWORD (Hardcoded) ---
        const MASTER_PASSWORD = "expense2025"; 
        
        // --- DEPLOYMENT-READY FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDA5iC_Fy7aa322POewfwRDC0umNJYtKIE",
            authDomain: "expense-management-70aed.firebaseapp.com",
            projectId: "expense-management-70aed",
            storageBucket: "expense-management-70aed.firebasestorage.app",
            messagingSenderId: "65855926325",
            appId: "1:65855926325:web:dc938a69c528c04d3f817c",
            measurementId: "G-ND3KE631NC"
        };
        
        // Derive the required appId from the config
        const appId = firebaseConfig.projectId; 
        const initialAuthToken = null; 

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let trendChartInstance = null; // Renamed chart instance
        let comparisonChartInstance = null; // New chart instance
        let allExpenses = [];

        // UI elements
        const authGate = document.getElementById('auth-gate');
        const mainApp = document.getElementById('app');
        const passwordForm = document.getElementById('password-form');
        const accessPasswordInput = document.getElementById('access-password');
        const passwordError = document.getElementById('password-error');

        const form = document.getElementById('expense-form');
        const expenseListUl = document.getElementById('expense-list');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noExpenses = document.getElementById('no-expenses');
        const filterCategorySelect = document.getElementById('filter-category');
        const filterStartDate = document.getElementById('filter-start-date');
        const filterEndDate = document.getElementById('filter-end-date');
        const messageBox = document.getElementById('message-box');
        const filterComparisonCategories = document.getElementById('filter-comparison-categories'); 

        // Data summary elements
        const currentMonthTotalDisplay = document.getElementById('current-month-total');
        const currentMonthLabelDisplay = document.getElementById('current-month-label');

        // UI elements for 'Other' category
        const categorySelect = document.getElementById('category');
        const otherCategoryContainer = document.getElementById('other-category-container');
        const otherCategoryInput = document.getElementById('other-category-input');

        // --- Authentication Gate Logic ---

        /**
         * Handles the password submission to grant access using the hardcoded password.
         */
        function handlePasswordSubmit(e) {
            e.preventDefault();
            const enteredPassword = accessPasswordInput.value;

            if (enteredPassword === MASTER_PASSWORD) {
                passwordError.classList.add('hidden');
                authGate.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initializeFirebase(); // Only initialize and load data after success
            } else {
                passwordError.classList.remove('hidden');
                accessPasswordInput.value = '';
                accessPasswordInput.focus();
            }
        }

        // --- Utility Functions ---

        /**
         * Shows a transient notification message to the user.
         * @param {string} message - The message content.
         * @param {string} type - 'success' or 'error'.
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // --- Firebase Initialization and Authentication ---

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Set session persistence to maintain login status
                await setPersistence(auth, browserSessionPersistence);

                // Sign in anonymously for a unique, shared session ID
                await signInAnonymously(auth);

                // Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Authenticated for shared access with UID:", currentUserId);
                        // Start loading data after successful authentication
                        setupRealtimeDataListener();
                        setupFilterListeners();
                        setupCategoryChangeListener(); 
                    } else {
                        currentUserId = null;
                        console.error("Authentication failed or user logged out.");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication error:", error);
                showMessage('Firebase failed to initialize. Check console for details.', 'error');
            }
        }

        // --- Data Interaction (Firestore) ---

        /**
         * Gets the Firestore collection path for the SHARED data.
         * @returns {string} The collection path.
         */
        function getExpensesCollectionPath() {
            if (!currentUserId) {
                throw new Error("User not authenticated.");
            }
            return `/artifacts/${appId}/public/data/shared_expenses`;
        }

        /**
         * Handles the submission of a new expense.
         */
        async function handleFormSubmit(e) {
            e.preventDefault();

            if (!currentUserId) {
                showMessage("Authentication required to save data. Please try again.", 'error');
                return;
            }

            const selectedCategory = categorySelect.value;
            let finalCategory = selectedCategory;

            if (selectedCategory === 'Other') {
                finalCategory = otherCategoryInput.value.trim();
                if (!finalCategory) {
                    showMessage("Please specify the 'Other' category.", 'error');
                    return;
                }
            }

            const newExpense = {
                category: finalCategory, 
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('date').value,
                person: document.getElementById('person').value || 'Self',
                createdAt: serverTimestamp() 
            };

            if (!newExpense.category || !newExpense.amount || !newExpense.date) {
                showMessage("Please fill in Category, Amount, and Date.", 'error');
                return;
            }

            try {
                const colRef = collection(db, getExpensesCollectionPath());
                await addDoc(colRef, newExpense);
                showMessage('Expense recorded successfully!', 'success');
                
                // Reset form and UI state
                form.reset();
                categorySelect.value = ""; 
                otherCategoryContainer.classList.add('hidden');
                otherCategoryInput.removeAttribute('required');
                otherCategoryInput.value = '';
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage('Failed to record expense. See console.', 'error');
            }
        }

        /**
         * Sets up the real-time listener for all expenses.
         */
        function setupRealtimeDataListener() {
            try {
                const colRef = collection(db, getExpensesCollectionPath());
                // NOTE: We only order by date here to keep the list chronological. Filters are applied in JS.
                const q = query(colRef, orderBy('date', 'desc')); 

                onSnapshot(q, (snapshot) => {
                    allExpenses = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    console.log("Expenses updated (Shared Pool):", allExpenses.length);
                    processAndRenderDashboard();
                }, (error) => {
                    console.error("Error listening to expenses:", error);
                    showMessage('Could not sync shared data in real-time. Check Security Rules.', 'error');
                });
            } catch (error) {
                console.error("Error setting up listener:", error.message);
            }
        }

        // --- Data Processing and Visualization ---

        /**
         * Aggregates expenses by month, category, and total monthly sum.
         */
        function aggregateData(expenses) {
            const monthlyCategoryTotals = {};
            let monthlyTotals = {};
            const allCategories = new Set();
            const allMonths = new Set();
            
            const today = new Date();
            const currentYearMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            let currentMonthSum = 0;

            expenses.forEach(expense => {
                const [year, month] = expense.date.split('-');
                const monthKey = `${year}-${month}`; 
                const category = expense.category;

                allMonths.add(monthKey);
                allCategories.add(category);

                if (!monthlyCategoryTotals[monthKey]) {
                    monthlyCategoryTotals[monthKey] = {};
                }

                // Aggregate by Category
                monthlyCategoryTotals[monthKey][category] = 
                    (monthlyCategoryTotals[monthKey][category] || 0) + expense.amount;
                
                // Aggregate Total Monthly Spend
                monthlyTotals[monthKey] = (monthlyTotals[monthKey] || 0) + expense.amount;

                // Calculate current month's sum
                if (monthKey === currentYearMonth) {
                    currentMonthSum += expense.amount;
                }
            });
            
            const sortedMonths = Array.from(allMonths).sort();

            return { monthlyCategoryTotals, monthlyTotals, allMonths: sortedMonths, allCategories: Array.from(allCategories).sort(), currentMonthSum };
        }

        /**
         * Filters the master list of expenses based ONLY on the date range.
         */
        function getDateFilteredExpenses() {
            const start = filterStartDate.value ? new Date(filterStartDate.value) : null;
            const end = filterEndDate.value ? new Date(filterEndDate.value) : null;

            return allExpenses.filter(expense => {
                let dateMatch = true;
                if (start || end) {
                    const expenseDate = new Date(expense.date);
                    expenseDate.setUTCHours(0, 0, 0, 0);

                    if (start && expenseDate < start) {
                        dateMatch = false;
                    }

                    if (end) {
                        dateMatch = dateMatch && (expenseDate <= end);
                    }
                }
                return dateMatch;
            });
        }
        
        /**
         * Filters a given list of expenses based ONLY on the single category filter.
         */
        function getExpensesForListAndMainChart(expenses) {
            const filterCategory = filterCategorySelect.value;
            // The input 'expenses' should be the date-filtered set.
            return expenses.filter(expense => {
                return filterCategory === 'all' || expense.category === filterCategory;
            });
        }
        
        // --- Chart Rendering Functions ---

        const CHART_COLORS = [
            '#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#6366f1', '#f97316', 
            '#06b6d4', '#eab308', '#ec4899', '#34d399', '#fb7185'
        ];
        
        /**
         * Renders the Overall Monthly Trend Line Chart (Total Spend).
         */
        function renderMonthlyTrendChart(aggregationResult) {
            const ctx = document.getElementById('monthly-trend-chart').getContext('2d');
            
            if (trendChartInstance) {
                trendChartInstance.destroy();
            }

            const dataKeys = aggregationResult.allMonths;
            
            const labels = dataKeys.map(key => {
                const [year, month] = key.split('-');
                return new Date(year, month - 1).toLocaleString('default', { month: 'short', year: 'numeric' });
            });
            
            const totals = dataKeys.map(key => aggregationResult.monthlyTotals[key] || 0);

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Monthly Expense (Rs)',
                        data: totals,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#1d4ed8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (Rs)' }
                        }
                    },
                    plugins: { tooltip: { mode: 'index', intersect: false } }
                }
            });
        }
        
        /**
         * Renders the Multi-Category Comparison Line Chart.
         */
        function renderCategoryComparisonChart(aggregationResult) {
            const ctx = document.getElementById('comparison-chart').getContext('2d');
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }

            const selectedCategories = Array.from(filterComparisonCategories.selectedOptions).map(opt => opt.value);
            const dataKeys = aggregationResult.allMonths;
            
            const labels = dataKeys.map(key => {
                const [year, month] = key.split('-');
                return new Date(year, month - 1).toLocaleString('default', { month: 'short', year: 'numeric' });
            });
            
            const datasets = selectedCategories.map((category, index) => {
                const color = CHART_COLORS[index % CHART_COLORS.length];
                
                const data = dataKeys.map(monthKey => {
                    return aggregationResult.monthlyCategoryTotals[monthKey][category] || 0;
                });
                
                return {
                    label: category,
                    data: data,
                    borderColor: color,
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 4,
                    pointBackgroundColor: color
                };
            });

            comparisonChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (Rs)' }
                        }
                    },
                    plugins: {
                        tooltip: { mode: 'index', intersect: false },
                        title: { display: false }
                    }
                }
            });
        }


        function renderExpenseList(expenses) {
            expenseListUl.innerHTML = '';
            loadingIndicator.classList.add('hidden');

            if (expenses.length === 0) {
                noExpenses.classList.remove('hidden');
                return;
            }

            noExpenses.classList.add('hidden');

            expenses.forEach(expense => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-3 px-2 transition duration-150 hover:bg-gray-50';
                li.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-lg font-medium text-gray-800">${expense.category}</p>
                        <p class="text-sm text-gray-500">
                            Logged by: ${expense.person || 'N/A'} - ${expense.date}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-red-600">Rs ${expense.amount.toLocaleString('en-IN')}</p>
                    </div>
                `;
                expenseListUl.appendChild(li);
            });
        }

        function updateCategoryFilters(allCategories) {
            const currentFilterValue = filterCategorySelect.value;
            const currentComparisonValues = Array.from(filterComparisonCategories.options).filter(o => o.selected).map(o => o.value);
            
            // 1. Update Single Select Filter (Global)
            filterCategorySelect.innerHTML = '<option value="all">All Categories</option>';
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterCategorySelect.appendChild(option);
            });
            filterCategorySelect.value = currentFilterValue;
            
            // 2. Update Multi-Select Filter (Comparison)
            filterComparisonCategories.innerHTML = '';
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                if (currentComparisonValues.includes(category)) {
                    option.selected = true;
                }
                filterComparisonCategories.appendChild(option);
            });
        }

        function processAndRenderDashboard() {
            // 1. Full aggregation data (for the top card and filter dropdowns)
            const fullAggregation = aggregateData(allExpenses); 
            
            // 2. Filter data by date (Base data set for all filtering)
            const dateFilteredExpenses = getDateFilteredExpenses(); 
            
            // 3. Filter data for the List and Main Trend Chart (respects category + date filters)
            const globallyFilteredExpenses = getExpensesForListAndMainChart(dateFilteredExpenses);
            const globalAggregationResult = aggregateData(globallyFilteredExpenses);

            // 4. Update the Current Month Total display (Based on ALL expenses, NOT filtered)
            const today = new Date();
            currentMonthTotalDisplay.textContent = `Rs ${fullAggregation.currentMonthSum.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            currentMonthLabelDisplay.textContent = today.toLocaleString('default', { month: 'long', year: 'numeric' });

            // 5. Update category filters based on ALL available data
            updateCategoryFilters(fullAggregation.allCategories);

            // 6. Render UI components (using the filtered aggregation data)
            renderExpenseList(globallyFilteredExpenses); 
            renderMonthlyTrendChart(globalAggregationResult); 
            
            // 7. Render Comparison Chart (Uses only date-filtered data, ignoring the single category filter)
            const comparisonAggregationResult = aggregateData(dateFilteredExpenses);
            renderCategoryComparisonChart(comparisonAggregationResult); 
        }

        // --- Event Listeners Setup ---

        function setupFilterListeners() {
            // These listeners trigger the main processing pipeline
            filterCategorySelect.addEventListener('change', processAndRenderDashboard);
            filterStartDate.addEventListener('change', processAndRenderDashboard);
            filterEndDate.addEventListener('change', processAndRenderDashboard);
            
            // FIX: Add the event listener for the comparison filter here instead of in the HTML
            filterComparisonCategories.addEventListener('change', processAndRenderDashboard);
        }

        function setupCategoryChangeListener() {
            categorySelect.addEventListener('change', () => {
                if (categorySelect.value === 'Other') {
                    otherCategoryContainer.classList.remove('hidden');
                    otherCategoryInput.setAttribute('required', 'required');
                    otherCategoryInput.focus();
                } else {
                    otherCategoryContainer.classList.add('hidden');
                    otherCategoryInput.removeAttribute('required');
                    otherCategoryInput.value = '';
                }
            });
        }


        // --- Application Start ---
        window.onload = () => {
            // Set up the password check before anything else
            passwordForm.addEventListener('submit', handlePasswordSubmit);
            form.addEventListener('submit', handleFormSubmit);

            // Set default date for new entry form to today
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
        };

    </script>
</body>
</html>
